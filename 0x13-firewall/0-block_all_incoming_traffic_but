#!/usr/bin/env bash
# Script that configures ufw firewall to block all incoming traffic except specific ports
# CRITICAL: This script ensures SSH access (port 22) is allowed before enabling firewall

# Install ufw if not already installed
apt-get update -y
apt-get install ufw -y

# Reset ufw to default settings
ufw --force reset

# CRITICAL: Allow SSH FIRST to prevent lockout
ufw allow 22/tcp

# Set default policies
ufw default deny incoming
ufw default allow outgoing

# Allow HTTP (port 80)
ufw allow 80/tcp

# Allow HTTPS (port 443)
ufw allow 443/tcp

# Verify SSH rule is in place before enabling
echo "Verifying SSH access rule..."
ufw status | grep "22/tcp"

# Enable ufw firewall
ufw --force enable

# Show ufw status
echo "Firewall enabled. Current rules:"
ufw status verbose

# Test connectivity reminder
echo "IMPORTANT: Test SSH connectivity from another server before logging out!"
echo "Example: telnet $(hostname -I | awk '{print $1}') 22"